<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Qu·∫£n l√Ω Nh√¢n vi√™n</title>
  <link rel="stylesheet" href="../sidebar.css" />
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #e9f1fb;
      margin-left: 300px;
      padding: 30px;
    }

    header h1 {
      font-size: 28px;
      margin-bottom: 20px;
    }

    #searchEmployee {
      display: block;
      margin: 0 auto 20px auto;
      padding: 10px 20px;
      width: 50%;
      border-radius: 50px;
      border: 1px solid #ccc;
      outline: none;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }

    #showAddFormBtn {
      background-color: #e74c3c;
      color: white;
      padding: 10px 20px;
      border-radius: 25px;
      border: none;
      cursor: pointer;
      font-weight: bold;
      margin-bottom: 15px;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }

    #showAddFormBtn:hover {
      background-color: #c0392b;
    }

    #addEmployeeForm,
#editEmployeeForm {
  display: none;
  margin: 20px auto;
  width: 80%;
  max-width: 800px;
  background: white;
  padding: 20px;
  border-radius: 16px;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
  text-align: center;
}

/* Input v√† Select ƒë·ªìng b·ªô */
#addEmployeeForm input,
#editEmployeeForm input,
#addEmployeeForm select,
#editEmployeeForm select {
  padding: 10px;
  width: calc(33% - 22px);
  margin: 10px;
  border-radius: 10px;
  border: 1px solid #ccc;
  font-size: 14px;
}

/* N√∫t L∆∞u */
#addEmployeeForm button {
  background-color: #e74c3c;
  color: white;
  padding: 10px 20px;
  border-radius: 25px;
  border: none;
  cursor: pointer;
  font-weight: bold;
}

#addEmployeeForm button:hover {
  background-color: #c0392b;
}

/* N√∫t C·∫≠p nh·∫≠t */
#editEmployeeForm button {
  background-color: #3498db;
  color: white;
  padding: 10px 20px;
  border-radius: 25px;
  border: none;
  cursor: pointer;
  font-weight: bold;
}

#editEmployeeForm button:hover {
  background-color: #2980b9;
}

    table {
      width: 1300px;
      border-collapse: separate;
      border-spacing: 0 10px;
    }

    th {
      text-align: center;
      background-color: #6cc3fd;
      color: white;
      padding: 12px;
    }

    tbody tr:nth-child(even) td {
      background-color: #cbe6f5;
    }

    tbody tr:nth-child(odd) td {
      background-color: white;
    }

    td {
      padding: 15px;
      text-align: center;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }

    button {
      padding: 6px 14px;
      border: none;
      border-radius: 16px;
      color: white;
      font-weight: bold;
      cursor: pointer;
      margin: 0 5px;
    }

    button:hover {
      opacity: 0.85;
    }

    .edit-btn {
      background-color: #3498db;
    }

    .delete-btn {
      background-color: #e74c3c;
    }

    .error-row {
      color: red;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <!-- Sidebar s·∫Ω ƒë∆∞·ª£c ch√®n ƒë·ªông -->
  <div id="sidebar-container"></div>

  <header>
  
  </header>

  <main>
    <input type="text" id="searchEmployee" placeholder="üîç T√¨m ki·∫øm theo t√™n..." />

    <!-- N√∫t hi·ªÉn th·ªã form th√™m -->
<button id="showAddFormBtn">‚ûï Th√™m nh√¢n vi√™n</button>

<!-- Form th√™m nh√¢n vi√™n -->
<div id="addEmployeeModal" class="modal">
  <form id="addEmployeeForm" class="modal-content">
    <h2>Th√™m nh√¢n vi√™n</h2>
    <input type="text" id="newName" placeholder="H·ªç t√™n" required />
    <select id="newRole" required>
      <option value="">-- Ch·ªçn ch·ª©c v·ª• --</option>
      <option value="Ph·ª•c v·ª•">Ph·ª•c v·ª•</option>
      <option value="B·∫øp tr∆∞·ªüng">B·∫øp tr∆∞·ªüng</option>
      <option value="Thu ng√¢n">Thu ng√¢n</option>
      <option value="Pha ch·∫ø">Pha ch·∫ø</option>
      <option value="B·∫£o v·ªá">B·∫£o v·ªá</option>
      <option value="Qu·∫£n l√Ω">Qu·∫£n l√Ω</option>
      <option value="Th·ªß kho">Th·ªß kho</option>
    </select>
    <input type="text" id="newPhone" placeholder="SƒêT" required />
    <button type="submit">L∆∞u</button>
  </form>
</div>

<!-- Form c·∫≠p nh·∫≠t nh√¢n vi√™n -->
<form id="editEmployeeForm" style="margin-top: 30px;">
  <h2>C·∫≠p nh·∫≠t nh√¢n vi√™n</h2>
  <input type="hidden" id="editId" />
  <input type="text" id="editName" placeholder="H·ªç t√™n" required />
  <select id="editRole" required>
    <option value="">-- Ch·ªçn ch·ª©c v·ª• --</option>
    <option value="Ph·ª•c v·ª•">Ph·ª•c v·ª•</option>
    <option value="B·∫øp tr∆∞·ªüng">B·∫øp tr∆∞·ªüng</option>
    <option value="Thu ng√¢n">Thu ng√¢n</option>
    <option value="Pha ch·∫ø">Pha ch·∫ø</option>
    <option value="B·∫£o v·ªá">B·∫£o v·ªá</option>
    <option value="Qu·∫£n l√Ω">Qu·∫£n l√Ω</option>
    <option value="Th·ªß kho">Th·ªß kho</option>
  </select>
  <input type="text" id="editPhone" placeholder="SƒêT" required />
  <button type="submit">C·∫≠p nh·∫≠t</button>
</form>

    <table id="employeeTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>H·ªç t√™n</th>
          <th>Ch·ª©c v·ª•</th>
          <th>SƒêT</th>
          <th>H√†nh ƒë·ªông</th>
        </tr>
      </thead>
      <tbody id="employeeBody">
        <tr><td colspan="5">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
      </tbody>
    </table>
  </main>

 <script>
  // T·∫£i sidebar
  fetch('../sidebar.html')
    .then(res => res.text())
    .then(html => {
      document.getElementById('sidebar-container').innerHTML = html;
      const basePath = window.location.pathname.includes('/pages/') ? '../' : './';
      document.querySelectorAll('.sidebar a').forEach(link => {
        const href = link.getAttribute('data-href');
        if (href) link.setAttribute('href', basePath + href);
      });
    });

  window.onload = () => {
    const tbody = document.getElementById('employeeBody');
    const searchInput = document.getElementById('searchEmployee');
    const addForm = document.getElementById('addEmployeeForm');
    const editForm = document.getElementById('editEmployeeForm');
    const showBtn = document.getElementById('showAddFormBtn');

    // üîç T√¨m ki·∫øm nh√¢n vi√™n
    searchInput.addEventListener('input', fetchEmployees);

    // üîÅ T·∫£i danh s√°ch nh√¢n vi√™n
    function fetchEmployees() {
      fetch('/api/employees/')
        .then(res => {
          if (!res.ok) throw new Error("Kh√¥ng th·ªÉ k·∫øt n·ªëi API");
          return res.json();
        })
        .then(data => renderEmployees(data))
        .catch(err => {
          console.error("‚ùå L·ªói:", err);
          tbody.innerHTML = '<tr><td colspan="5" class="error-row">Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu nh√¢n vi√™n</td></tr>';
        });
    }

    // üßæ Hi·ªÉn th·ªã danh s√°ch nh√¢n vi√™n
    function renderEmployees(data) {
      const keyword = searchInput.value.trim().toLowerCase();
      const filtered = data.filter(nv =>
        nv.HoTenNhanVien.toLowerCase().includes(keyword)
      );

      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5">Kh√¥ng t√¨m th·∫•y nh√¢n vi√™n</td></tr>';
        return;
      }

      tbody.innerHTML = '';
      filtered.forEach(nv => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${nv.NhanVienID}</td>
          <td>${nv.HoTenNhanVien}</td>
          <td>${nv.VaiTro}</td>
          <td>${nv.SoDienThoai}</td>
          <td>
            <button class="edit-btn" onclick="editEmployee(${nv.NhanVienID}, '${nv.HoTenNhanVien}', '${nv.VaiTro}', '${nv.SoDienThoai}')">S·ª≠a</button>
            <button class="delete-btn" onclick="deleteEmployee(${nv.NhanVienID})">X√≥a</button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    // ‚òéÔ∏è Ki·ªÉm tra s·ªë ƒëi·ªán tho·∫°i Vi·ªát Nam
    function isValidVietnamesePhone(phone) {
      const cleaned = phone.replace(/[\s\-\(\)\.]/g, '');
      let normalized = cleaned;
      if (cleaned.startsWith('+84')) {
        normalized = '0' + cleaned.slice(3);
      } else if (cleaned.startsWith('84')) {
        normalized = '0' + cleaned.slice(2);
      }
      const regex = /^0(3[2-9]|5[6|8|9]|7[0|6-9]|8[1-9]|9[0-9])\d{7}$/;

      if (/[^0-9]/.test(normalized)) {
        alert("‚ùå S·ªë ƒëi·ªán tho·∫°i ch·ªâ ƒë∆∞·ª£c ch·ª©a c√°c ch·ªØ s·ªë.");
        return false;
      }
      if (normalized.length !== 10) {
        alert("‚ùå S·ªë ƒëi·ªán tho·∫°i ph·∫£i ƒë·ªß 10 ch·ªØ s·ªë.");
        return false;
      }
      if (/^(\d)\1{9}$/.test(normalized)) {
        alert("‚ùå S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá: kh√¥ng ƒë∆∞·ª£c l√† chu·ªói tr√πng l·∫∑p.");
        return false;
      }
      if (!regex.test(normalized)) {
        alert("‚ùå S·ªë ƒëi·ªán tho·∫°i kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng di ƒë·ªông Vi·ªát Nam.");
        return false;
      }
      return true;
    }

    // ‚ûï Hi·ªán/·∫©n form th√™m
    showBtn.addEventListener('click', () => {
      addForm.style.display = addForm.style.display === 'none' || addForm.style.display === '' ? 'block' : 'none';
    });

    // ‚úÖ G·ª≠i form th√™m nh√¢n vi√™n
    addForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const ten = document.getElementById('newName').value.trim();
      const vaitro = document.getElementById('newRole').value.trim();
      const sdt = document.getElementById('newPhone').value.trim();

      if (!ten || !vaitro || !sdt) {
        alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin");
        return;
      }
      if (!isValidVietnamesePhone(sdt)) return;

      fetch('/api/employees/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ HoTenNhanVien: ten, VaiTro: vaitro, SoDienThoai: sdt })
      })
        .then(res => res.json())
        .then(data => {
          alert(data.message);
          addForm.reset();
          addForm.style.display = 'none';
          fetchEmployees();
        })
        .catch(err => {
          console.error("‚ùå L·ªói khi th√™m:", err);
          alert("Th√™m th·∫•t b·∫°i");
        });
    });

    // ‚úèÔ∏è Hi·ªÉn th·ªã form s·ª≠a
    window.editEmployee = (id, oldName, oldRole, oldPhone) => {
      editForm.style.display = 'block';
      document.getElementById('editId').value = id;
      document.getElementById('editName').value = oldName;
      document.getElementById('editRole').value = oldRole;
      document.getElementById('editPhone').value = oldPhone;
    };

    // ‚úÖ G·ª≠i form c·∫≠p nh·∫≠t
    editForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const id = document.getElementById('editId').value;
      const ten = document.getElementById('editName').value.trim();
      const vaitro = document.getElementById('editRole').value.trim();
      const sdt = document.getElementById('editPhone').value.trim();

      if (!ten || !vaitro || !sdt) {
        alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin");
        return;
      }
      if (!isValidVietnamesePhone(sdt)) return;

      fetch(`/api/employees/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ HoTenNhanVien: ten, VaiTro: vaitro, SoDienThoai: sdt })
      })
        .then(res => res.json())
        .then(data => {
          alert(data.message);
          editForm.reset();
          editForm.style.display = 'none';
          fetchEmployees();
        })
        .catch(err => {
          console.error("‚ùå L·ªói khi c·∫≠p nh·∫≠t:", err);
          alert("Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t nh√¢n vi√™n");
        });
    });

    // üóëÔ∏è X√≥a nh√¢n vi√™n
    window.deleteEmployee = (id) => {
      if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a nh√¢n vi√™n n√†y?")) {
        fetch(`/api/employees/${id}`, { method: 'DELETE' })
          .then(res => res.json())
          .then(data => {
            alert(data.message);
            fetchEmployees();
          })
          .catch(err => {
            console.error("‚ùå L·ªói khi x√≥a:", err);
            alert("Kh√¥ng th·ªÉ x√≥a nh√¢n vi√™n v√¨ nh√¢n vi√™n ƒëang x·ª≠ l√Ω h√≥a ƒë∆°n");
          });
      }
    };

    // üöÄ T·∫£i danh s√°ch ban ƒë·∫ßu
    fetchEmployees();
  };
</script>


</body>
</html>
